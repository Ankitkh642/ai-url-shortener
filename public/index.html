<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI URL Shortener</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }

        .header {
            margin-bottom: 40px;
            position: relative;
        }

        .created-by {
            position: absolute;
            bottom: 10px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            flex: 1;
            text-align: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Authentication Styles */
        .auth-buttons {
            display: flex;
            gap: 10px;
        }

        .auth-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .auth-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .auth-btn.signup {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .auth-btn.signup:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        .auth-btn.admin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .auth-btn.logout {
            background: #dc3545;
            color: white;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #333;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        .form-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-submit:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
            transform: translateY(-1px);
        }

        .form-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .form-link {
            text-align: center;
            margin-top: 15px;
        }

        .form-link a {
            color: #667eea;
            text-decoration: none;
        }

        .form-link a:hover {
            text-decoration: underline;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            color: #28a745;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        /* Modern Dashboard Styles */
        .dashboard-modal {
            max-width: 1200px;
            width: 95vw;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 24px 30px;
            border-bottom: 1px solid #f0f0f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }

        .dashboard-title {
            font-size: 1.8rem;
            margin: 0 0 8px 0;
            font-weight: 700;
        }

        .dashboard-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .dashboard-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .dashboard-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .dashboard-body {
            padding: 30px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .modern-stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .modern-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .dashboard-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #f0f0f0;
        }

        .section-header {
            padding: 20px 24px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 200px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sort-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .urls-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .urls-grid {
            display: grid;
            gap: 16px;
            padding: 20px;
        }

        .url-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .url-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .url-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .url-short {
            font-weight: 600;
            color: #667eea;
            text-decoration: none;
            font-size: 1.1rem;
        }

        .url-short:hover {
            text-decoration: underline;
        }

        .url-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            background: #d4edda;
            color: #155724;
        }

        .url-original {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 12px;
            word-break: break-all;
            line-height: 1.4;
        }

        .url-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .url-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #666;
        }

        .url-stat-number {
            font-weight: 600;
            color: #333;
        }

        .url-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .modern-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modern-action-btn:hover {
            transform: translateY(-1px);
        }

        .btn-copy {
            background: #28a745;
            color: white;
        }

        .btn-copy:hover {
            background: #218838;
        }

        .btn-qr {
            background: #6f42c1;
            color: white;
        }

        .btn-qr:hover {
            background: #5a32a3;
        }

        .btn-analytics {
            background: #17a2b8;
            color: white;
        }

        .btn-analytics:hover {
            background: #138496;
        }

        /* Legacy admin styles */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 500;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 500;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn.edit {
            background: #ffc107;
            color: black;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-right {
                justify-content: center;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
            }

            .dashboard-modal {
                width: 100vw;
                height: 100vh;
                max-width: none;
                max-height: none;
                border-radius: 0;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .dashboard-body {
                padding: 20px 16px;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 24px;
            }

            .modern-stat-card {
                padding: 20px;
            }

            .stat-icon {
                width: 50px;
                height: 50px;
                font-size: 2rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .section-controls {
                flex-direction: column;
                gap: 8px;
            }

            .search-input {
                width: 100%;
            }

            .url-card {
                padding: 16px;
            }

            .url-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .url-short {
                font-size: 0.9rem;
                word-break: break-all;
            }

            .url-stats {
                flex-direction: column;
                gap: 8px;
            }

            .url-actions {
                justify-content: center;
            }

            .modern-action-btn {
                flex: 1;
                justify-content: center;
                min-width: 80px;
            }

            .admin-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .data-table {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .dashboard-body {
                padding: 16px 12px;
            }

            .modern-stat-card {
                padding: 16px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .stat-content {
                text-align: center;
            }

            .url-actions {
                flex-direction: column;
                gap: 8px;
            }

            .modern-action-btn {
                flex: none;
                width: 100%;
            }
        }

        .form-container {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .short-url {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #28a745;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .short-url a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .url-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .ai-badge {
            display: inline-block !important;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
            color: #ffffff !important;
            padding: 8px 16px !important;
            border-radius: 20px !important;
            font-size: 14px !important;
            font-weight: 800 !important;
            margin-left: 10px !important;
            line-height: 1 !important;
            white-space: nowrap !important;
            vertical-align: middle !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            border: 2px solid #333 !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        h1 .ai-badge {
            color: #ffffff !important;
            text-decoration: none !important;
        }

        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>AI URL Shortener</h1>
                    <p>Shorten URLs with advanced AI spam detection and comprehensive analytics</p>
                </div>
                <div class="header-right">
                    <div id="authButtons" class="auth-buttons">
                        <button id="loginBtn" class="auth-btn">Login</button>
                        <button id="signupBtn" class="auth-btn signup">Sign Up</button>
                    </div>
                    <div id="userMenu" class="user-menu" style="display: none;">
                        <span id="userName" class="user-name">Welcome, User!</span>
                        <button id="dashboardBtn" class="auth-btn">Dashboard</button>
                        <button id="adminBtn" class="auth-btn admin" style="display: none;">Admin</button>
                        <button id="logoutBtn" class="auth-btn logout">Logout</button>
                    </div>
                </div>
            </div>
            <div class="created-by">created by Ankit</div>
        </div>

        <div class="form-container">
            <form id="shortenForm">
                <div class="input-group">
                    <input 
                        type="url" 
                        id="longUrl" 
                        class="input-field" 
                        placeholder="Enter your long URL here..."
                        required
                    >
                    <button type="submit" class="btn" id="shortenBtn">
                        <span class="btn-text">Shorten</span>
                        <div class="loader" id="loader"></div>
                    </button>
                </div>
                
                <div class="options">
                    <input 
                        type="text" 
                        id="customAlias" 
                        class="input-field" 
                        placeholder="Custom alias (optional)"
                    >
                    <input 
                        type="text" 
                        id="title" 
                        class="input-field" 
                        placeholder="Title (optional)"
                    >
                </div>
            </form>

            <div id="result" class="result"></div>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalUrls">-</div>
                <div class="stat-label">URLs Shortened</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalClicks">-</div>
                <div class="stat-label">Total Clicks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueClicks">-</div>
                <div class="stat-label">Unique Clicks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="blockedUrls">-</div>
                <div class="stat-label">Threats Blocked</div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="loginModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Login</h2>
                <p>Access your URL dashboard</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginIdentifier">Email or Username</label>
                    <input type="text" id="loginIdentifier" class="form-input" required>
                    <div class="error-message" id="loginIdentifierError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                <button type="submit" class="form-submit" id="loginSubmit">Login</button>
                <div class="error-message" id="loginError"></div>
                <div class="success-message" id="loginSuccess"></div>
            </form>
            <div class="form-link">
                <p>Don't have an account? <a href="#" id="showSignup">Sign up here</a></p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close" data-modal="signupModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Sign Up</h2>
                <p>Create your account to track URLs</p>
            </div>
            <form id="signupForm">
                <div class="form-group">
                    <label class="form-label" for="signupUsername">Username</label>
                    <input type="text" id="signupUsername" class="form-input" required>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        3-30 characters, letters, numbers, and underscores only
                    </div>
                    <div class="error-message" id="signupUsernameError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" class="form-input" required>
                    <div class="error-message" id="signupEmailError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" class="form-input" required>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        Must be at least 6 characters with uppercase, lowercase, and number
                    </div>
                    <div class="error-message" id="signupPasswordError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" id="signupConfirmPassword" class="form-input" required>
                    <div class="error-message" id="signupConfirmPasswordError"></div>
                </div>
                <button type="submit" class="form-submit" id="signupSubmit">Sign Up</button>
                <div class="error-message" id="signupError"></div>
                <div class="success-message" id="signupSuccess"></div>
            </form>
            <div class="form-link">
                <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content dashboard-modal">
            <span class="close" data-modal="dashboardModal">&times;</span>
            <div class="dashboard-header">
                <div class="dashboard-header-content">
                    <h2 class="dashboard-title">üìä Your Dashboard</h2>
                    <p class="dashboard-subtitle">Monitor and manage your shortened URLs</p>
                </div>
                <div class="dashboard-actions">
                    <button class="dashboard-btn" onclick="refreshDashboard()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            
            <div id="dashboardContent" class="dashboard-body">
                <div class="dashboard-stats">
                    <div class="modern-stat-card">
                        <div class="stat-icon">üîó</div>
                        <div class="stat-content">
                            <div class="stat-number" id="userUrls">-</div>
                            <div class="stat-label">URLs Created</div>
                        </div>
                    </div>
                    <div class="modern-stat-card">
                        <div class="stat-icon">üëÜ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="userClicks">-</div>
                            <div class="stat-label">Total Clicks</div>
                        </div>
                    </div>
                    <div class="modern-stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <div class="stat-number" id="userUniqueClicks">-</div>
                            <div class="stat-label">Unique Clicks</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header">
                        <h3 class="section-title">üîó Your URLs</h3>
                        <div class="section-controls">
                            <input type="text" class="search-input" placeholder="üîç Search URLs..." id="urlSearch">
                            <select class="sort-select" id="urlSort">
                                <option value="createdAt">Latest First</option>
                                <option value="clickCount">Most Clicked</option>
                                <option value="shortId">Alphabetical</option>
                            </select>
                        </div>
                    </div>
                    <div id="urlsTableContainer" class="urls-container">
                        <div id="urlsTable" class="loading-state">
                            <div class="loading-spinner"></div>
                            <p>Loading your URLs...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" data-modal="adminModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Admin Panel</h2>
                <p>System administration and management</p>
            </div>
            <div id="adminContent">
                <div class="admin-tabs">
                    <button class="admin-tab active" data-tab="overview">Overview</button>
                    <button class="admin-tab" data-tab="users">Users</button>
                    <button class="admin-tab" data-tab="urls">URLs</button>
                    <button class="admin-tab" data-tab="analytics">Analytics</button>
                </div>
                <div id="adminTabContent">
                    <div id="overviewTab" class="admin-tab-content active">
                        <h3>System Overview</h3>
                        <div class="admin-stats">
                            <div class="stat-card">
                                <div class="stat-number" id="adminTotalUsers">-</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="adminTotalUrls">-</div>
                                <div class="stat-label">Total URLs</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="adminTotalClicks">-</div>
                                <div class="stat-label">Total Clicks</div>
                            </div>
                        </div>
                    </div>
                    <div id="usersTab" class="admin-tab-content">
                        <h3>User Management</h3>
                        <div id="usersTable">Loading users...</div>
                    </div>
                    <div id="urlsTab" class="admin-tab-content">
                        <h3>URL Management</h3>
                        <div id="adminUrlsTable">Loading URLs...</div>
                    </div>
                    <div id="analyticsTab" class="admin-tab-content">
                        <h3>System Analytics</h3>
                        <div id="analyticsContent">Loading analytics...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close" data-modal="qrModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">QR Code</h2>
                <p id="qrUrlText">Scan to visit your short URL</p>
            </div>
            <div id="qrCodeContainer" style="padding: 20px;">
                <div id="qrLoader" style="display: none;">Generating QR code...</div>
                <img id="qrCodeImage" style="max-width: 100%; display: none;" alt="QR Code">
            </div>
            <div style="margin-top: 20px;">
                <button id="downloadQRBtn" class="form-submit" style="display: none;">Download QR Code</button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" data-modal="analyticsModal">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">URL Analytics</h2>
                <p id="analyticsUrlText">Detailed statistics for your URL</p>
            </div>
            <div id="analyticsContent">
                <div id="analyticsLoader">Loading analytics...</div>
                <div id="analyticsData" style="display: none;">
                    <div class="admin-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="analyticsTotalClicks">-</div>
                            <div class="stat-label">Total Clicks</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analyticsUniqueClicks">-</div>
                            <div class="stat-label">Unique Clicks</div>
                        </div>
                    </div>
                    <div id="analyticsDetails" style="margin-top: 20px;">
                        <!-- Additional analytics details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const form = document.getElementById('shortenForm');
            const resultDiv = document.getElementById('result');
            const loader = document.getElementById('loader');
            const btnText = document.querySelector('.btn-text');
            const shortenBtn = document.getElementById('shortenBtn');

            if (!form) {
                return;
            }

            // Load stats on page load
            loadStats();

            form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const longUrl = document.getElementById('longUrl').value;
            const customAlias = document.getElementById('customAlias').value;
            const title = document.getElementById('title').value;

            // Show loading state
            showLoading(true);
            
            try {
                // Prepare headers with auth token if user is logged in
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                const token = localStorage.getItem('authToken');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch('/api/urls/shorten', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        longUrl,
                        customAlias: customAlias || undefined,
                        title: title || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showResult(data.data, 'success');
                    form.reset();
                    loadStats(); // Refresh stats
                    
                    // Refresh dashboard if user is logged in
                    const user = localStorage.getItem('user');
                    if (user && document.getElementById('dashboardModal').style.display === 'block') {
                        loadUserDashboard();
                    }
                } else {
                    showResult({ error: data.error }, 'error');
                }
            } catch (error) {
                showResult({ error: 'Network error. Please try again.' }, 'error');
            } finally {
                showLoading(false);
            }
        });

        function showLoading(loading) {
            if (loading) {
                loader.style.display = 'block';
                btnText.style.display = 'none';
                shortenBtn.disabled = true;
            } else {
                loader.style.display = 'none';
                btnText.style.display = 'block';
                shortenBtn.disabled = false;
            }
        }

        function showResult(data, type) {
            resultDiv.className = `result ${type}`;
            
            if (type === 'success') {
                resultDiv.innerHTML = `
                    <h3>‚úÖ URL shortened successfully!</h3>
                    <div class="short-url">
                        <a href="${data.shortUrl}" target="_blank">${data.shortUrl}</a>
                        <div class="url-actions">
                            <button class="copy-btn" data-url="${data.shortUrl}">Copy</button>
                            <button class="qr-btn" data-short-id="${data.shortId}" style="background: #6f42c1; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin-left: 8px;">QR Code</button>
                        </div>
                    </div>
                    <p><strong>Original:</strong> ${data.longUrl}</p>
                    ${data.aiSafetyScore ? `<p><strong>AI Safety Score:</strong> ${(data.aiSafetyScore * 100).toFixed(1)}%</p>` : ''}
                `;
                
                // Add event listeners to the action buttons
                const copyBtn = resultDiv.querySelector('.copy-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', function(event) {
                        const url = this.getAttribute('data-url');
                        copyToClipboard(url, this);
                    });
                }

                const qrBtn = resultDiv.querySelector('.qr-btn');
                if (qrBtn) {
                    qrBtn.addEventListener('click', function() {
                        const shortId = this.getAttribute('data-short-id');
                        showQRCode(shortId);
                    });
                }
            } else {
                resultDiv.innerHTML = `
                    <h3>‚ùå Error</h3>
                    <p>${data.error}</p>
                `;
            }
        }

        function copyToClipboard(text, btn) {
            console.log('Main page copy function called with text:', text);
            // Check if the Clipboard API is available
            if (navigator.clipboard && window.isSecureContext) {
                // Modern browsers
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(btn);
                }).catch(err => {
                    // Fallback if clipboard API fails
                    fallbackCopyTextToClipboard(text, btn);
                });
            } else {
                // Fallback for older browsers or non-secure contexts
                fallbackCopyTextToClipboard(text, btn);
            }
        }

        function fallbackCopyTextToClipboard(text, btn) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(btn);
                } else {
                    showCopyError(btn);
                }
            } catch (err) {
                showCopyError(btn);
            }
            
            document.body.removeChild(textArea);
        }

        function showCopySuccess(btn) {
            const originalText = btn.textContent;
            const originalBg = btn.style.backgroundColor;
            btn.textContent = 'Copied!';
            btn.style.backgroundColor = '#28a745';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.backgroundColor = originalBg;
            }, 2000);
        }

        function showCopyError(btn) {
            const originalText = btn.textContent;
            const originalBg = btn.style.backgroundColor;
            btn.textContent = 'Failed';
            btn.style.backgroundColor = '#dc3545';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.backgroundColor = originalBg;
            }, 2000);
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalUrls').textContent = data.data.totalUrls.toLocaleString();
                    document.getElementById('totalClicks').textContent = data.data.totalClicks.toLocaleString();
                    document.getElementById('uniqueClicks').textContent = data.data.uniqueClicks.toLocaleString();
                    document.getElementById('blockedUrls').textContent = data.data.blockedUrls.toLocaleString();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                // Fallback to dash if stats can't be loaded
                document.getElementById('totalUrls').textContent = '-';
                document.getElementById('totalClicks').textContent = '-';
                document.getElementById('uniqueClicks').textContent = '-';
                document.getElementById('blockedUrls').textContent = '-';
            }
        }
        
        // Authentication functionality
        const authButtons = document.getElementById('authButtons');
        const userMenu = document.getElementById('userMenu');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const adminBtn = document.getElementById('adminBtn');

        // Modal elements
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const dashboardModal = document.getElementById('dashboardModal');
        const adminModal = document.getElementById('adminModal');

        // Check if user is logged in on page load
        checkAuthStatus();

        // Modal event listeners
        loginBtn.addEventListener('click', () => openModal('loginModal'));
        signupBtn.addEventListener('click', () => openModal('signupModal'));
        dashboardBtn.addEventListener('click', () => openModal('dashboardModal'));
        adminBtn.addEventListener('click', () => openModal('adminModal'));
        logoutBtn.addEventListener('click', logout);

        // Close modal listeners
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                closeModal(e.target.getAttribute('data-modal'));
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Switch between login and signup
        document.getElementById('showSignup').addEventListener('click', (e) => {
            e.preventDefault();
            closeModal('loginModal');
            openModal('signupModal');
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            closeModal('signupModal');
            openModal('loginModal');
        });

        // Form submissions
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('signupForm').addEventListener('submit', handleSignup);

        // Admin tab switching
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                switchAdminTab(tabName);
            });
        });

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'dashboardModal') {
                loadUserDashboard();
            } else if (modalId === 'adminModal') {
                loadAdminData();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('loginSubmit');
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ identifier, password })
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.user));
                    showMessage('loginSuccess', 'Login successful!');
                    setTimeout(() => {
                        closeModal('loginModal');
                        updateAuthUI(data.data.user);
                    }, 1000);
                } else {
                    showMessage('loginError', data.error || 'Login failed');
                }
            } catch (error) {
                showMessage('loginError', 'Network error. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
        }

        async function handleSignup(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('signupSubmit');
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            // Clear previous error messages
            document.querySelectorAll('#signupModal .error-message').forEach(el => el.style.display = 'none');

            // Frontend validation
            let hasErrors = false;

            // Username validation
            if (username.length < 3 || username.length > 30) {
                showFieldError('signupUsernameError', 'Username must be 3-30 characters');
                hasErrors = true;
            } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showFieldError('signupUsernameError', 'Username can only contain letters, numbers, and underscores');
                hasErrors = true;
            }

            // Email validation
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFieldError('signupEmailError', 'Please enter a valid email address');
                hasErrors = true;
            }

            // Password validation
            if (password.length < 6) {
                showFieldError('signupPasswordError', 'Password must be at least 6 characters');
                hasErrors = true;
            } else if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(password)) {
                showFieldError('signupPasswordError', 'Password must contain at least one lowercase, one uppercase, and one number');
                hasErrors = true;
            }

            // Confirm password validation
            if (password !== confirmPassword) {
                showFieldError('signupConfirmPasswordError', 'Passwords do not match');
                hasErrors = true;
            }

            if (hasErrors) {
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';

            try {
                console.log('Sending registration data:', { username, email, password: '***' });
                
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    showMessage('signupSuccess', 'Account created successfully! Please login.');
                    setTimeout(() => {
                        closeModal('signupModal');
                        openModal('loginModal');
                        // Clear form
                        document.getElementById('signupForm').reset();
                    }, 1500);
                } else {
                    // Handle validation errors from backend
                    if (data.errors && Array.isArray(data.errors)) {
                        data.errors.forEach(error => {
                            if (error.path === 'username') {
                                showFieldError('signupUsernameError', error.msg);
                            } else if (error.path === 'email') {
                                showFieldError('signupEmailError', error.msg);
                            } else if (error.path === 'password') {
                                showFieldError('signupPasswordError', error.msg);
                            }
                        });
                    } else {
                        showMessage('signupError', data.error || data.message || 'Registration failed');
                    }
                }
            } catch (error) {
                console.error('Network error:', error);
                showMessage('signupError', 'Network error. Please try again.');
            }

            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign Up';
        }

        function showFieldError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            updateAuthUI(null);
        }

        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                try {
                    const userData = JSON.parse(user);
                    updateAuthUI(userData);
                } catch (error) {
                    logout();
                }
            }
        }

        function updateAuthUI(user) {
            if (user) {
                authButtons.style.display = 'none';
                userMenu.style.display = 'flex';
                document.getElementById('userName').textContent = `Welcome, ${user.username}!`;
                
                if (user.role === 'admin') {
                    adminBtn.style.display = 'block';
                } else {
                    adminBtn.style.display = 'none';
                }
            } else {
                authButtons.style.display = 'flex';
                userMenu.style.display = 'none';
            }
        }

        function showMessage(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        async function loadUserDashboard() {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!token || !user.id) return;

            // Reset search and sort controls for fresh dashboard view
            const searchInput = document.getElementById('urlSearch');
            const sortSelect = document.getElementById('urlSort');
            if (searchInput) searchInput.value = '';
            if (sortSelect) sortSelect.value = 'createdAt';

            // Show loading state
            document.getElementById('urlsTable').innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Loading your URLs...</p>
                </div>
            `;

            try {
                // Load user stats and URLs in parallel
                const [statsResponse, urlsResponse] = await Promise.all([
                    fetch('/api/auth/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`/api/urls/user/${user.id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                const [statsData, urlsData] = await Promise.all([
                    statsResponse.json(),
                    urlsResponse.json()
                ]);

                // Update stats
                if (statsData.success) {
                    console.log('Stats data received:', statsData.data);
                    document.getElementById('userUrls').textContent = statsData.data.urls?.total || 0;
                    document.getElementById('userClicks').textContent = statsData.data.clicks?.total || 0;
                }

                // Calculate unique clicks from URLs data
                if (urlsData.success && urlsData.data) {
                    const totalUniqueClicks = urlsData.data.reduce((sum, url) => sum + (url.uniqueClickCount || 0), 0);
                    document.getElementById('userUniqueClicks').textContent = totalUniqueClicks;
                    // Display original data (not filtered)
                    displayUserUrls(urlsData.data, false);
                } else {
                    document.getElementById('userUniqueClicks').textContent = 0;
                    // Clear both arrays when no data
                    originalUrls = [];
                    allUserUrls = [];
                    displayUserUrls([], false);
                }

                // Add event listeners for search and sort (with better handling)
                const searchInput = document.getElementById('urlSearch');
                const sortSelect = document.getElementById('urlSort');
                
                if (searchInput && !searchInput.hasEventListener) {
                    // Remove any existing listeners first
                    searchInput.removeEventListener('input', filterAndSortUrls);
                    searchInput.removeEventListener('keyup', filterAndSortUrls);
                    
                    // Add fresh listeners
                    searchInput.addEventListener('input', function() {
                        console.log('Search input changed:', this.value);
                        filterAndSortUrls();
                    });
                    searchInput.addEventListener('keyup', function() {
                        console.log('Search keyup:', this.value);
                        filterAndSortUrls();
                    });
                    searchInput.hasEventListener = true;
                }
                
                if (sortSelect && !sortSelect.hasEventListener) {
                    sortSelect.removeEventListener('change', filterAndSortUrls);
                    sortSelect.addEventListener('change', function() {
                        console.log('Sort changed:', this.value);
                        filterAndSortUrls();
                    });
                    sortSelect.hasEventListener = true;
                }

            } catch (error) {
                console.error('Failed to load user dashboard:', error);
                document.getElementById('urlsTable').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error Loading</h3>
                        <p>Failed to load your URLs. Please try refreshing.</p>
                    </div>
                `;
            }
        }

        let allUserUrls = []; // Store all URLs for filtering/sorting
        let originalUrls = []; // Store the original complete list

        function displayUserUrls(urls, isFiltered = false) {
            // Only store original data if this is not a filtered result
            if (!isFiltered) {
                allUserUrls = [...urls]; // Store copy for search/sort functionality
                originalUrls = [...urls]; // Store original data
            }
            
            const urlsContainer = document.getElementById('urlsTable');
            
            if (!urls || urls.length === 0) {
                // Check if this is due to filtering (search term exists but no results)
                const searchTerm = document.getElementById('urlSearch')?.value.trim() || '';
                if (searchTerm && originalUrls && originalUrls.length > 0) {
                    urlsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No results found</h3>
                            <p>No URLs match your search term "<strong>${searchTerm}</strong>". Try a different search or clear the search box.</p>
                            <button onclick="clearSearch()" class="dashboard-btn" style="margin-top: 16px; background: #667eea; color: white;">Clear Search</button>
                        </div>
                    `;
                } else {
                    urlsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîó</div>
                            <h3>No URLs yet</h3>
                            <p>You haven't created any URLs yet. Create your first short URL to get started!</p>
                        </div>
                    `;
                }
                return;
            }

            const urlCards = urls.map(url => `
                <div class="url-card" data-url-data='${JSON.stringify(url)}'>
                    <div class="url-card-header">
                        <a href="${window.location.origin}/${url.shortId}" target="_blank" class="url-short">
                            üîó ${window.location.origin}/${url.shortId}
                        </a>
                        <span class="url-status">Active</span>
                    </div>
                    
                    <div class="url-original" title="${url.longUrl}">
                        üìÑ ${url.longUrl.length > 80 ? url.longUrl.substring(0, 80) + '...' : url.longUrl}
                    </div>
                    
                    <div class="url-stats">
                        <div class="url-stat">
                            <span>üëÜ <span class="url-stat-number">${url.clickCount || 0}</span> total clicks</span>
                        </div>
                        <div class="url-stat">
                            <span>üë• <span class="url-stat-number">${url.uniqueClickCount || 0}</span> unique</span>
                        </div>
                        <div class="url-stat">
                            <span>üìÖ ${new Date(url.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                    
                    <div class="url-actions">
                        <button class="modern-action-btn btn-copy copy-url-btn" data-url="${window.location.origin}/${url.shortId}">
                            üìã Copy
                        </button>
                        <button class="modern-action-btn btn-qr qr-code-btn" data-short-id="${url.shortId}">
                            üì± QR Code
                        </button>
                        <button class="modern-action-btn btn-analytics analytics-btn" data-short-id="${url.shortId}">
                            üìä Analytics
                        </button>
                    </div>
                </div>
            `).join('');

            urlsContainer.innerHTML = `<div class="urls-grid">${urlCards}</div>`;

            // Add event listeners to the action buttons
            urlsContainer.querySelectorAll('.copy-url-btn').forEach(btn => {
                btn.addEventListener('click', function(event) {
                    const url = this.getAttribute('data-url');
                    copyUrlToClipboard(url, event);
                });
            });

            urlsContainer.querySelectorAll('.qr-code-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const shortId = this.getAttribute('data-short-id');
                    showQRCode(shortId);
                });
            });

            urlsContainer.querySelectorAll('.analytics-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const shortId = this.getAttribute('data-short-id');
                    viewAnalytics(shortId);
                });
            });
        }

        function filterAndSortUrls() {
            const searchTerm = document.getElementById('urlSearch')?.value.toLowerCase().trim() || '';
            const sortBy = document.getElementById('urlSort')?.value || 'createdAt';
            
            console.log('filterAndSortUrls called - searchTerm:', `"${searchTerm}"`, 'originalUrls length:', originalUrls?.length);
            
            // If no URLs loaded yet, return early
            if (!originalUrls || originalUrls.length === 0) {
                console.log('No original URLs, returning early');
                return;
            }
            
            // Filter URLs - always use originalUrls as the source
            let filteredUrls;
            if (searchTerm === '') {
                filteredUrls = [...originalUrls]; // Show all URLs when search is cleared
                console.log('Search cleared, showing all URLs:', filteredUrls.length);
            } else {
                filteredUrls = originalUrls.filter(url => 
                    url.longUrl.toLowerCase().includes(searchTerm) ||
                    url.shortId.toLowerCase().includes(searchTerm)
                );
                console.log('Filtered URLs:', filteredUrls.length, 'out of', originalUrls.length);
            }
            
            // Sort URLs
            filteredUrls.sort((a, b) => {
                switch (sortBy) {
                    case 'clickCount':
                        return (b.clickCount || 0) - (a.clickCount || 0);
                    case 'shortId':
                        return a.shortId.localeCompare(b.shortId);
                    case 'createdAt':
                    default:
                        return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });
            
            // Update allUserUrls for any subsequent operations but mark as filtered
            allUserUrls = [...filteredUrls];
            
            // Display filtered results (isFiltered = true to avoid overwriting originalUrls)
            displayUserUrls(filteredUrls, true);
        }

        function refreshDashboard() {
            loadUserDashboard();
        }



        async function loadAdminData() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                console.log('Admin dashboard data:', data);
                
                if (data.success) {
                    document.getElementById('adminTotalUsers').textContent = data.data.overview?.users?.total || 0;
                    document.getElementById('adminTotalUrls').textContent = data.data.overview?.urls?.total || 0;
                    document.getElementById('adminTotalClicks').textContent = data.data.overview?.clicks?.total || 0;
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
            }
        }

        function switchAdminTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Load data for the selected tab
            if (tabName === 'users') {
                loadUsersData();
            } else if (tabName === 'urls') {
                loadUrlsData();
            } else if (tabName === 'analytics') {
                loadAnalyticsData();
            }
        }

        async function loadUsersData() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/api/admin/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    displayUsersTable(data.data.users);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTable').innerHTML = 'Failed to load users';
            }
        }

        async function loadUrlsData() {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            try {
                const response = await fetch('/api/admin/urls', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    displayUrlsTable(data.data.urls);
                }
            } catch (error) {
                console.error('Failed to load URLs:', error);
                document.getElementById('adminUrlsTable').innerHTML = 'Failed to load URLs';
            }
        }

        function displayUsersTable(users) {
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>URLs</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${user.role}</td>
                                <td>${user.totalUrls || 0}</td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <button class="action-btn edit" onclick="editUser('${user._id}')">Edit</button>
                                    <button class="action-btn delete" onclick="deleteUser('${user._id}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('usersTable').innerHTML = table;
        }

        function displayUrlsTable(urls) {
            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Short ID</th>
                            <th>Long URL</th>
                            <th>Clicks</th>
                            <th>Created</th>
                            <th>User</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${urls.map(url => `
                            <tr>
                                <td>${url.shortId}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${url.longUrl}">${url.longUrl}</td>
                                <td>${url.clickCount || 0}</td>
                                <td>${new Date(url.createdAt).toLocaleDateString()}</td>
                                <td>${url.userId?.username || 'Anonymous'}</td>
                                <td>
                                    <button class="action-btn delete" onclick="deleteUrl('${url._id}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('adminUrlsTable').innerHTML = table;
        }

        function loadAnalyticsData() {
            document.getElementById('analyticsContent').innerHTML = `
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number">${document.getElementById('adminTotalUsers').textContent}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${document.getElementById('adminTotalUrls').textContent}</div>
                        <div class="stat-label">Total URLs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${document.getElementById('adminTotalClicks').textContent}</div>
                        <div class="stat-label">Total Clicks</div>
                    </div>
                </div>
                <p>Advanced analytics features coming soon...</p>
            `;
        }

        // Global functions for URL actions
        window.copyUrlToClipboard = async function(url, event) {
            console.log('Copy function called with URL:', url);
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(url);
                    console.log('Copied using clipboard API');
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    console.log('Copied using fallback method');
                }
                
                // Show success message briefly - improved for new design
                const button = event?.target?.closest('.copy-url-btn') || event?.target;
                if (button) {
                    const originalHTML = button.innerHTML;
                    const originalBg = button.style.background;
                    button.innerHTML = '‚úÖ Copied!';
                    button.style.background = '#28a745';
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.background = originalBg || '#28a745';
                        button.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Copy error:', error);
                // Show error state
                const button = event?.target?.closest('.copy-url-btn') || event?.target;
                if (button) {
                    const originalHTML = button.innerHTML;
                    const originalBg = button.style.background;
                    button.innerHTML = '‚ùå Failed';
                    button.style.background = '#dc3545';
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.style.background = originalBg || '#28a745';
                    }, 2000);
                }
            }
        };

        // Global refresh function
        window.refreshDashboard = function() {
            if (document.getElementById('dashboardModal').style.display === 'block') {
                loadUserDashboard();
            }
        };

        // Global clear search function
        window.clearSearch = function() {
            const searchInput = document.getElementById('urlSearch');
            const sortSelect = document.getElementById('urlSort');
            if (searchInput) {
                searchInput.value = '';
                // Reset sort to default as well
                if (sortSelect) {
                    sortSelect.value = 'createdAt';
                }
                // Show all original URLs
                if (originalUrls && originalUrls.length > 0) {
                    displayUserUrls([...originalUrls], false); // Reset to original data
                    // Update the current working set
                    allUserUrls = [...originalUrls];
                }
            }
        };

        window.showQRCode = async function(shortId) {
            console.log('QR function called with shortId:', shortId);
            const qrModal = document.getElementById('qrModal');
            const qrLoader = document.getElementById('qrLoader');
            const qrCodeImage = document.getElementById('qrCodeImage');
            const downloadBtn = document.getElementById('downloadQRBtn');
            const qrUrlText = document.getElementById('qrUrlText');
            
            // Show modal and loader
            qrModal.style.display = 'block';
            qrLoader.style.display = 'block';
            qrCodeImage.style.display = 'none';
            downloadBtn.style.display = 'none';
            
            const shortUrl = `${window.location.origin}/${shortId}`;
            qrUrlText.textContent = shortUrl;
            console.log('Fetching QR code for:', shortUrl);

            try {
                const response = await fetch(`/api/urls/${shortId}/qr`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    }
                });

                console.log('QR response status:', response.status);
                const data = await response.json();
                console.log('QR response data:', data);
                
                if (data.success) {
                    qrCodeImage.src = data.data.qrCode;
                    qrCodeImage.style.display = 'block';
                    downloadBtn.style.display = 'block';
                    qrLoader.style.display = 'none';
                    
                    // Set up download functionality
                    downloadBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.download = `qr-code-${shortId}.png`;
                        link.href = data.data.qrCode;
                        link.click();
                    };
                } else {
                    qrLoader.textContent = `Failed to generate QR code: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                qrLoader.textContent = 'Error generating QR code';
                console.error('QR code error:', error);
            }
        };

        window.viewAnalytics = async function(shortId) {
            console.log('Analytics function called with shortId:', shortId);
            const analyticsModal = document.getElementById('analyticsModal');
            const analyticsLoader = document.getElementById('analyticsLoader');
            const analyticsData = document.getElementById('analyticsData');
            const analyticsUrlText = document.getElementById('analyticsUrlText');
            
            // Show modal and loader
            analyticsModal.style.display = 'block';
            analyticsLoader.style.display = 'block';
            analyticsData.style.display = 'none';
            
            const shortUrl = `${window.location.origin}/${shortId}`;
            analyticsUrlText.textContent = shortUrl;
            console.log('Fetching analytics for:', shortUrl);

            try {
                const response = await fetch(`/api/urls/${shortId}/analytics`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                console.log('Analytics response status:', response.status);
                const data = await response.json();
                console.log('Analytics response data:', data);
                
                if (data.success) {
                    const analytics = data.data;
                    document.getElementById('analyticsTotalClicks').textContent = analytics.totalClicks || 0;
                    document.getElementById('analyticsUniqueClicks').textContent = analytics.uniqueClicks || 0;
                    
                    // Add additional analytics details
                    const detailsHtml = `
                        <h4>Click Details</h4>
                        <p><strong>Created:</strong> ${new Date(analytics.createdAt).toLocaleString()}</p>
                        <p><strong>Last Click:</strong> ${analytics.lastClick ? new Date(analytics.lastClick).toLocaleString() : 'Never'}</p>
                        ${analytics.topCountries ? `<p><strong>Top Country:</strong> ${analytics.topCountries[0]?.country || 'Unknown'}</p>` : ''}
                        ${analytics.topDevices ? `<p><strong>Top Device:</strong> ${analytics.topDevices[0]?.device || 'Unknown'}</p>` : ''}
                    `;
                    document.getElementById('analyticsDetails').innerHTML = detailsHtml;
                    
                    analyticsData.style.display = 'block';
                    analyticsLoader.style.display = 'none';
                } else {
                    analyticsLoader.textContent = `Failed to load analytics: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                analyticsLoader.textContent = 'Error loading analytics';
                console.error('Analytics error:', error);
            }
        };

        // Global functions for admin actions
        window.editUser = function(userId) {
            alert('Edit user functionality coming soon...');
        };

        window.deleteUser = async function(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    loadUsersData(); // Refresh the table
                } else {
                    alert('Failed to delete user: ' + data.error);
                }
            } catch (error) {
                alert('Network error while deleting user');
            }
        };

        window.deleteUrl = async function(urlId) {
            if (!confirm('Are you sure you want to delete this URL?')) return;
            
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`/api/admin/urls/${urlId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                if (data.success) {
                    loadUrlsData(); // Refresh the table
                } else {
                    alert('Failed to delete URL: ' + data.error);
                }
            } catch (error) {
                alert('Network error while deleting URL');
            }
        };

        }); // Close DOMContentLoaded event listener
    </script>
</body>
</html> 